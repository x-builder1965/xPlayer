# FFmpegã‚³ãƒ¼ãƒ‡ãƒƒã‚¯æ€§èƒ½æ¯”è¼ƒè¡¨

## 1. ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€ãƒ¼åˆ¥æ€§èƒ½æ¯”è¼ƒ

| ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€ | GPUè£½é€ å…ƒ | æ€§èƒ½|å“è³ª | ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰é©ç”¨ç®‡æ‰€ | æ¨å¥¨åº¦ |
|-----------|---------|--------|------|------------------|--------|
| **libx264** | âŒ CPU | â­â­ | â­â­â­â­â­ | ç¾åœ¨xPlayerã§ä½¿ç”¨ä¸­ | ğŸŸ¡ ä¸­ |
| **h264_nvenc** | âœ… NVIDIA | â­â­â­â­â­ | â­â­â­â­ | æ–°è¦å®Ÿè£…ï¼ˆGPUå¯¾å¿œï¼‰ | ğŸŸ¢ é«˜ |
| **h264_qsv** | âœ… Intel | â­â­â­â­ | â­â­â­â­ | æ–°è¦å®Ÿè£…ï¼ˆGPUå¯¾å¿œï¼‰ | ğŸŸ¢ é«˜ |
| **h264_amf** | âœ… AMD | â­â­â­ | â­â­â­ | æ–°è¦å®Ÿè£…ï¼ˆGPUå¯¾å¿œï¼‰ | ğŸŸ¡ ä¸­ |

---

## 2. ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ™‚é–“ã®ç›®å®‰ï¼ˆ2æ™‚é–“å‹•ç”»ï¼‰

### CPU ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€ï¼ˆlibx264ï¼‰
```
Intel i5-10400ï¼ˆ6Coreï¼‰ã§ã®å®Ÿæ¸¬å€¤:
- preset "veryfast": ç´„ 3ï½4æ™‚é–“
- preset "fast":    ç´„ 6ï½8æ™‚é–“
- preset "medium":  ç´„ 12ï½16æ™‚é–“
```

### GPU ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€
```
3080 Ti + i5-10400ã®çµ„ã¿åˆã‚ã›:
- h264_nvenc: ç´„ 30ï½50åˆ† ï¼ˆæœ€å¤§ 10å€é«˜é€ŸåŒ–ï¼‰
- h264_qsv:  ç´„ 40ï½60åˆ† ï¼ˆ8ï½10å€é«˜é€ŸåŒ–ï¼‰
- h264_amf:  ç´„ 50ï½80åˆ† ï¼ˆ3ï½5å€é«˜é€ŸåŒ–ï¼‰
```

---

## 3. ãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆè¨­å®šã‚¬ã‚¤ãƒ‰

### æ¨å¥¨è¨­å®šï¼ˆH.264ï¼‰

| ç”¨é€” | è§£åƒåº¦ | ãƒ“ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆ | ç”¨ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯ | å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºï¼ˆ2hå‹•ç”»ï¼‰ |
|------|--------|-----------|-----------|------------------------|
| ä½å“è³ª | 720p | 800k - 1.2M | libx264 | 360MB - 540MB |
| æ¨™æº–  | 720p | 2.5M - 3.5M | libx264 | 900MB - 1.2GB |
| é«˜å“è³ª| 1080p | 4M - 6M | libx264 | 1.8GB - 2.7GB |
| é«˜å“è³ª| 4K | 15M - 25M | h264_nvenc | 6.75GB - 11.25GB |

### ç¾åœ¨ã®xPlayerè¨­å®š
```javascript
// å‹•ç”»å¤‰æ›: CRF 23 (å“è³ªã¨åœ§ç¸®ç‡ã®ãƒãƒ©ãƒ³ã‚¹)
// éŸ³å£°: 192kbps (AAC)
// ãƒ—ãƒªã‚»ãƒƒãƒˆ: veryfast (é€Ÿåº¦å„ªå…ˆ)
```

---

## 4. ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æœ€é©åŒ–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

### libx264ï¼ˆCPUï¼‰ã®å ´åˆ
```javascript
// ç¾åœ¨ã®xPlayerè¨­å®š
{
    codec: 'libx264',
    preset: 'veryfast',      // â† é€Ÿåº¦å„ªå…ˆ
    crf: 23,                 // â† å“è³ªã¨åœ§ç¸®ç‡ã®ãƒãƒ©ãƒ³ã‚¹
    "x264-params": "aq-mode=3"  // â† é©å¿œé‡å­åŒ–ï¼ˆæ¨å¥¨ï¼‰
}
```

### h264_nvencï¼ˆNVIDIA GPUï¼‰ã¸ã®æ¨å¥¨å¤‰æ›´
```javascript
{
    codec: 'h264_nvenc',
    preset: 'fast',          // â† default, fast, medium, slow
    rc: 'vbr',               // â† Rate Control: vbr(å¯å¤‰), cbr(å›ºå®š)
    'rc-lookahead': '20',    // â† ãƒ•ãƒ¬ãƒ¼ãƒ å…ˆèª­ã¿ï¼ˆå“è³ªå‘ä¸Šï¼‰
    'temporal-aq': '1'       // â† æ™‚é–“çš„é©å¿œé‡å­åŒ–
}
```

### h264_qsvï¼ˆIntel GPUï¼‰ã¸ã®æ¨å¥¨å¤‰æ›´
```javascript
{
    codec: 'h264_qsv',
    preset: 'fast',          // â† veryfast, faster, fast, medium
    global_quality: 23,      // â† ICQï¼ˆIntelligent Constant Qualityï¼‰
    look_ahead: 1            // â† ãƒ«ãƒƒã‚¯ãƒ˜ãƒƒãƒ‰æœ‰åŠ¹åŒ–
}
```

---

## 5. CPUä½¿ç”¨ç‡ä½æ¸›ã®åŠ¹æœ

### å‹•ç”»å¤‰æ›ä¸­ã®ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨çŠ¶æ³

#### ç¾åœ¨ï¼ˆCPU ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ libx264 veryfastï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        CPUä½¿ç”¨ç‡            â”‚
â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 95%   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        GPUä½¿ç”¨ç‡            â”‚
â”‚  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 0% â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        ãƒ¡ãƒ¢ãƒª               â”‚
â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 30%   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### GPUå¯¾å¿œå¾Œï¼ˆNVIDIA h264_nvencï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        CPUä½¿ç”¨ç‡            â”‚
â”‚  â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 10% â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        GPUä½¿ç”¨ç‡            â”‚
â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 80%    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        ãƒ¡ãƒ¢ãƒª               â”‚
â”‚  â–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 15%â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. å®Ÿè£…é›£æ˜“åº¦ã¨å„ªå…ˆåº¦ãƒãƒˆãƒªãƒƒã‚¯ã‚¹

```
å„ªå…ˆåº¦ ï¼ˆé«˜ï¼‰ â†‘
        â”‚
        â”‚  NVIDIA h264_nvenc â­â­â­â­â­
        â”‚  (é›£æ˜“åº¦: ä½ï½ä¸­)
        â”‚
        â”‚  Intel h264_qsv  â­â­â­â­
        â”‚  (é›£æ˜“åº¦: ä¸­)
        â”‚
        â”‚  AMD h264_amf    â­â­â­
        â”‚  (é›£æ˜“åº¦: ä¸­)
        â”‚
        â”‚  libx264ï¼ˆç¾åœ¨ï¼‰
        â”‚  (é›£æ˜“åº¦: å®Ÿè£…æ¸ˆ)
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ
                                ï¼ˆé«˜ï¼‰
```

---

## 7. FFmpeg ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯æ¤œå‡ºã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆNode.jsï¼‰

### ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯è‡ªå‹•æ¤œå‡ºã®å®Ÿè£…ä¾‹

```javascript
const { execSync } = require('child_process');

function detectAvailableCodecs(ffmpegPath) {
    try {
        // FFmpegæœ¬ä½“ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€ä¸€è¦§ã‚’å–å¾—
        const output = execSync(`"${ffmpegPath}" -codecs -hide_banner 2>&1`).toString();
        
        const available = {
            nvidiaNvenc: output.includes('h264_nvenc'),
            intelQsv: output.includes('h264_qsv'),
            amdAmf: output.includes('h264_amf'),
            libx264: output.includes('libx264')
        };
        
        return available;
    } catch (e) {
        console.error('ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯æ¤œå‡ºå¤±æ•—:', e);
        return { libx264: true };  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    }
}

function selectOptimalCodec(availableCodecs) {
    // å„ªå…ˆåº¦é †ã«é¸æŠ
    const priority = [
        // NVIDIA (æœ€é€Ÿ)
        { check: 'nvidiaNvenc', codec: 'h264_nvenc', preset: 'fast', category: 'NVIDIA' },
        // Intel
        { check: 'intelQsv', codec: 'h264_qsv', preset: 'fast', category: 'Intel' },
        // AMD
        { check: 'amdAmf', codec: 'h264_amf', preset: '7', category: 'AMD' },
        // CPU ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        { check: 'libx264', codec: 'libx264', preset: 'veryfast', category: 'CPU' }
    ];
    
    for (const option of priority) {
        if (availableCodecs[option.check]) {
            console.log(`âœ… Selected codec: ${option.codec} (${option.category})`);
            return option;
        }
    }
    
    throw new Error('No suitable codec available');
}

// ä½¿ç”¨ä¾‹
const codecs = detectAvailableCodecs('ffmpeg');
const selected = selectOptimalCodec(codecs);
console.log(selected);
// Output: { check: 'nvidiaNvenc', codec: 'h264_nvenc', preset: 'fast', category: 'NVIDIA' }
```

---

## 8. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### GPU ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãŒæ©Ÿèƒ½ã—ãªã„å ´åˆ

| ç—‡çŠ¶ | åŸå›  | å¯¾å‡¦æ–¹æ³• |
|------|------|--------|
| h264_nvenc not found | NVIDIA ãƒ‰ãƒ©ã‚¤ãƒæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« | NVIDIA ãƒ‰ãƒ©ã‚¤ãƒã‚’æœ€æ–°ç‰ˆã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ |
| Encoding failed / NVENC error | GPU ãƒ¡ãƒ¢ãƒªä¸è¶³ | ä»–ã®GPUå‡¦ç†ã‚’çµ‚äº†ã€CRFå€¤ã‚’ä¸Šã’ã‚‹ï¼ˆå“è³ªä¸‹ã’ï¼‰ |
| Slower than CPU | GPU ãƒ¬ã‚´ã‚·ãƒ†ã‚£ä¸è¶³ | CPU ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ |
| Color distortion | ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¨­å®šä¸é©åˆ‡ | ã‚«ãƒ©ãƒ¼ã‚¹ãƒšãƒ¼ã‚¹/ãƒ”ã‚¯ã‚»ãƒ«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ç¢ºèª |

---

## å‚è€ƒè³‡æ–™

### FFmpeg å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- NVIDIA NVENC: https://docs.nvidia.com/video-technologies/video-codec-sdk/12.1/ffmpeg-installation-guide/
- Intel Media SDK: https://github.com/Intel-Media-SDK/MediaSDK
- AMD VCE: https://en.wikipedia.org/wiki/Video_Codec_Engine

### H.264 åœ§ç¸®ãƒ¬ãƒ™ãƒ«æ—©è¦‹è¡¨
```
CRFå€¤ç¯„å›²: 0-51 (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 23)
  0-20  : æœ€é«˜å“è³ªï¼ˆãƒ•ã‚¡ã‚¤ãƒ«å®¹é‡å¤§ï¼‰
  20-25 : é«˜å“è³ªï¼ˆæ¨å¥¨ï¼‰ â† xPlayerã®ç¾åœ¨å€¤: 23
  25-35 : æ¨™æº–å“è³ª
  35-51 : ä½å“è³ªï¼ˆãƒ•ã‚¡ã‚¤ãƒ«å®¹é‡å°ï¼‰
```

